---
  # this needs full disk and change other apps permissions
- name: Set up macOS
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Install Homebrew if not present
      shell: |
        if ! command -v brew &> /dev/null; then
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
      args:
        executable: /bin/bash

    - name: Install Homebrew packages
      loop:
      - mas
      - yt-dlp
      - ffmpeg
      - htop
      
      - homebrew:
          name: "{{ item }}"
          state: present
      loop_control:
        label: "{{ item }}"
              

    - name: Download Brave browser DMG
      get_url:
        url: https://laptop-updates.brave.com/latest/osx/Brave-Browser.dmg
        dest: /tmp/Brave-Browser.dmg

    - name: Mount the DMG
      command: hdiutil attach /tmp/Brave-Browser.dmg -nobrowse -quiet
      register: mounted_dmg

    - name: Install Brave
      command: cp -R /Volumes/Brave\ Browser/Brave\ Browser.app /Applications/
      when: mounted_dmg is succeeded

    - name: Unmount the DMG
      command: hdiutil detach /Volumes/Brave\ Browser
      when: mounted_dmg is succeeded

    - name: Install applications from the Mac App Store
      loop:
        - { name: "Telegram", id: "747648890" }
        - { name: "The Unarchiver", id: "425424353" }
        - { name: Bitwarden, id: "1352778147" }

      command: mas install {{ item.id }}
      register: mas_install_results
      changed_when: "'Already installed' not in mas_install_results.stdout"
      loop_control:
        label: "{{ item.name }}"
    
    - name: macos settings
      shell: |
        defaults write com.apple.universalaccess reduceTransparency -bool true # Reduce transparency
        defaults write com.apple.dock autohide -bool true # Automatically hide and show the Dock


        killall SystemUIServer
      args:
        executable: /bin/bash