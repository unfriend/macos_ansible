---
  # this needs full disk and change other apps permissions
- name: Set up macOS
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Install Homebrew if not present
      shell: |
        if ! command -v brew &> /dev/null; then
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
      args:
        executable: /bin/bash

    - name: Install mas (Mac App Store command line interface)
      homebrew:
        name: mas
        state: present

    - name: Install yt-dlp
      homebrew:
        name: yt-dlp
        state: present

    - name: Download Brave browser DMG
      get_url:
        url: https://laptop-updates.brave.com/latest/osx/Brave-Browser.dmg
        dest: /tmp/Brave-Browser.dmg

    - name: Mount the DMG
      command: hdiutil attach /tmp/Brave-Browser.dmg -nobrowse -quiet
      register: mounted_dmg

    - name: Install Brave
      command: cp -R /Volumes/Brave\ Browser/Brave\ Browser.app /Applications/
      when: mounted_dmg is succeeded

    - name: Unmount the DMG
      command: hdiutil detach /Volumes/Brave\ Browser
      when: mounted_dmg is succeeded

    - name: Install Telegram from App Store
      shell: |
          mas install 747648890
      args:
        executable: /bin/bash

    - name: Enable Reduce transparency
      shell: |
        defaults write com.apple.universalaccess reduceTransparency -bool true
        killall SystemUIServer
      args:
        executable: /bin/bash
